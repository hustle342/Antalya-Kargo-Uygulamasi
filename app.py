# -*- coding: utf-8 -*-
"""Untitled0.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1bpspIfIRxAoVwG07eP_v2f22cf2VL8jx
"""

# Commented out IPython magic to ensure Python compatibility.
# %%writefile app.py
# import numpy as np
# import random
# import googlemaps
# import pandas as pd
# import folium
# import streamlit as st
# import plotly.express as px
# from streamlit_folium import folium_static
# from datetime import datetime
# 
# # ====================================================================
# # A. VERÄ° YAPISI VE SABÄ°TLER (Antalya/MuratpaÅŸa 21 Nokta)
# # ====================================================================
# 
# # BaÅŸlangÄ±Ã§ noktasÄ± Kargo Merkezi dahil 21 durak.
# NOKTA_KOORDINATLARI = {
#     "Kargo Merkezi (0)": (36.862423, 30.730075),
#     "Carrefoursa (1)": (36.864163, 30.729206),
#     "Mcdonald's (2)": (36.862628, 30.729913),
#     "Nejat BalÄ±k (3)": (36.861220, 30.728667),
#     "Moon Lara (4)": (36.859961, 30.731056),
#     "GÃ¶z BalÄ±k Lara (5)": (36.858038, 30.734946),
#     "Seda Yerli (6)": (36.865133, 30.733993),
#     "Fahreneit Coffee (7)": (36.865768, 30.733036),
#     "NallÄ±bahÃ§e (8)": (36.870950, 30.738125),
#     "Ã‡orbacÄ± Åemsi (9)": (36.864815, 30.741842),
#     "Tahtakale ÅirinyalÄ± (10)": (36.862563, 30.743249),
#     "Laura AVM (11)": (36.858174, 30.746641),
#     "Punto Emlak (12)": (36.863311, 30.737444),
#     "Samet SaÄŸlam KuafÃ¶r (13)": (36.860230, 30.735989),
#     "7 KÃ¶fte (14)": (36.859184, 30.736851),
#     "SarÄ± Demlik (15)": (36.858136, 30.739758),
#     "DHL (16)": (36.858269, 30.742237),
#     "Leticia (17)": (36.857887, 30.744275),
#     "Loft 1502 (18)": (36.857174, 30.744532),
#     "La Maja (19)": (36.857831, 30.745047),
#     "MM Migros (20)": (36.858102, 30.746131)
# }
# 
# nokta_isimleri = list(NOKTA_KOORDINATLARI.keys())
# koordinatlar = list(NOKTA_KOORDINATLARI.values())
# durak_sayisi = len(nokta_isimleri)
# 
# # ====================================================================
# # B. GOOGLE MAPS API Ä°LE MESAFA MATRÄ°SÄ° (HATA DÃœZELTÄ°LDÄ°)
# # ====================================================================
# 
# # API Ä°stemcisi baÅŸlatma ve gÃ¼venlik kontrolÃ¼
# gmaps_istemcisi = None
# API_ANAHTARI = None
# 
# try:
#     # 1. API AnahtarÄ±nÄ± gÃ¼venli dosyadan okur
#     API_ANAHTARI = st.secrets["google_maps"]["api_key"]
# 
#     # 2. Ä°stemciyi baÅŸlatÄ±rken okunan deÄŸiÅŸkeni kullanÄ±r
#     gmaps_istemcisi = googlemaps.Client(key=API_ANAHTARI)
# 
# except KeyError:
#     st.error("HATA: API AnahtarÄ± bulunamadÄ±. LÃ¼tfen `.streamlit/secrets.toml` dosyanÄ±zÄ± kontrol edin.")
# except Exception:
#     st.error("API Ä°stemcisi baÅŸlatÄ±lamadÄ±.")
# 
# 
# @st.cache_data(show_spinner="GerÃ§ek Yol Mesafeleri HesaplanÄ±yor...")
# def gercek_mesafe_matrisi_olustur(koordinat_listesi):
#     """
#     Verilen koordinatlar arasÄ±ndaki gerÃ§ek sÃ¼rÃ¼ÅŸ mesafelerini (KM) hesaplar ve matris dÃ¶ndÃ¼rÃ¼r.
#     """
#     if gmaps_istemcisi is None:
#         # Hata varsa Ã§ok bÃ¼yÃ¼k deÄŸer matrisi dÃ¶ndÃ¼r
#         return np.zeros((durak_sayisi, durak_sayisi)) + 999999.0
# 
#     N = len(koordinat_listesi)
#     mesafe_matrisi = np.zeros((N, N))
#     now = datetime.now()
# 
#     origins_destinations = [f"{lat},{lng}" for lat, lng in koordinat_listesi]
# 
#     for i in range(N):
#         for j in range(N):
#             if i == j:
#                 continue
# 
#             origin = origins_destinations[i]
#             destination = origins_destinations[j]
# 
#             try:
#                 sonuc = gmaps_istemcisi.distance_matrix(
#                     origins=[origin],
#                     destinations=[destination],
#                     mode="driving",
#                     departure_time=now
#                 )
# 
#                 element = sonuc['rows'][0]['elements'][0]
# 
#                 if element['status'] == 'OK':
#                     mesafe_km = element['distance']['value'] / 1000.0
#                     mesafe_matrisi[i, j] = mesafe_km
#                 else:
#                     mesafe_matrisi[i, j] = 999999.0
# 
#             except Exception:
#                 mesafe_matrisi[i, j] = 999999.0
# 
#     return mesafe_matrisi
# 
# # ====================================================================
# # C. KARINCA KOLONÄ°SÄ° ALGORÄ°TMASI (ACO) SINIFI - NAN/INF HATASI DÃœZELTÄ°LDÄ°
# # ====================================================================
# 
# class KarincaKolonisiOptimizasyonu:
#     def __init__(self, mesafeler, karinca_sayisi, iterasyon_sayisi, alfa, beta, buharlasma_orani):
#         self.mesafeler = mesafeler
#         self.durak_sayisi = len(mesafeler)
#         self.karinca_sayisi = karinca_sayisi
#         self.iterasyon_sayisi = iterasyon_sayisi
#         self.alfa = alfa
#         self.beta = beta
#         self.buharlasma_orani = buharlasma_orani
# 
#         # Heuristik Bilgi (GÃ¶rÃ¼nÃ¼rlÃ¼k): 1 / Mesafe
#         self.gorunurluk = 1.0 / (mesafeler + np.identity(self.durak_sayisi) * 1e-6)
# 
#         # Feromon matrisi baÅŸlangÄ±Ã§ deÄŸeri
#         self.feromon = np.ones((self.durak_sayisi, self.durak_sayisi)) / self.durak_sayisi
# 
#         self.en_iyi_rota = None
#         self.en_kisa_mesafe = np.inf
#         self.mesafe_gecmisi = []
# 
#     def _toplam_mesafe_hesapla(self, rota):
#         """Bir rotanÄ±n toplam mesafesini hesaplar (turu tamamlar)."""
#         mesafe = 0
#         for i in range(len(rota)):
#             baslangic_durak = rota[i]
#             bitis_durak = rota[(i + 1) % self.durak_sayisi]
#             mesafe += self.mesafeler[baslangic_durak, bitis_durak]
#         return mesafe
# 
#     def _sonraki_duragi_sec(self, mevcut_durak, ziyaret_edilenler):
#         """KarÄ±nca iÃ§in bir sonraki durak seÃ§imini olasÄ±lÄ±ksal yapar."""
# 
#         ziyaret_edilmeyenler_indeks = [durak for durak in range(self.durak_sayisi) if durak not in ziyaret_edilenler]
# 
#         if not ziyaret_edilmeyenler_indeks:
#             return None
# 
#         feromon_degerleri = self.feromon[mevcut_durak, ziyaret_edilmeyenler_indeks]
#         gorunurluk_degerleri = self.gorunurluk[mevcut_durak, ziyaret_edilmeyenler_indeks]
# 
#         # KRÄ°TÄ°K DÃœZELTME: NaN ve Sonsuz (Inf) deÄŸerleri temizle
#         gorunurluk_degerleri[np.isinf(gorunurluk_degerleri)] = 0.0
#         feromon_degerleri[np.isnan(feromon_degerleri)] = 0.0
# 
#         pay = (feromon_degerleri ** self.alfa) * (gorunurluk_degerleri ** self.beta)
#         payda = np.sum(pay)
# 
#         if payda == 0 or np.any(np.isnan(pay)):
#             # TÃ¼m yollar tÄ±kalÄ±ysa rastgele seÃ§im yap.
#             olasiliklar = np.ones(len(ziyaret_edilmeyenler_indeks)) / len(ziyaret_edilmeyenler_indeks)
#         else:
#             olasiliklar = pay / payda
# 
#         # KRÄ°TÄ°K KONTROL: Kayan nokta hatasÄ± iÃ§in olasÄ±lÄ±klarÄ± normalleÅŸtir.
#         if not np.isclose(np.sum(olasiliklar), 1.0):
#              olasiliklar /= np.sum(olasiliklar)
# 
# 
#         # OlasÄ±lÄ±ÄŸa gÃ¶re bir sonraki durak seÃ§imi
#         secilen_indeks = np.random.choice(
#             len(ziyaret_edilmeyenler_indeks),
#             p=olasiliklar
#         )
#         sonraki_durak = ziyaret_edilmeyenler_indeks[secilen_indeks]
# 
#         return sonraki_durak
# 
#     def _rota_olustur(self, baslangic_durak):
#         """Bir karÄ±ncanÄ±n tam rotasÄ±nÄ± oluÅŸturur."""
#         rota = [baslangic_durak]
#         ziyaret_edilenler = {baslangic_durak}
# 
#         for _ in range(self.durak_sayisi - 1):
#             mevcut_durak = rota[-1]
#             sonraki_durak = self._sonraki_duragi_sec(mevcut_durak, ziyaret_edilenler)
# 
#             if sonraki_durak is None: break
# 
#             rota.append(sonraki_durak)
#             ziyaret_edilenler.add(sonraki_durak)
# 
#         return rota
# 
#     def _feromon_guncelle(self, rotalar, rota_mesafeleri):
#         """BuharlaÅŸma ve yeni birikim ile feromon matrisini gÃ¼nceller."""
# 
#         # 1. BuharlaÅŸma
#         self.feromon *= (1.0 - self.buharlasma_orani)
# 
#         # 2. Yeni feromon birikimi
#         for rota, mesafe in zip(rotalar, rota_mesafeleri):
#             if mesafe <= 0 or mesafe >= 999999.0: continue
# 
#             # Feromon miktarÄ±: 1 / Mesafe
#             feromon_birikimi = 1.0 / mesafe
# 
#             for i in range(len(rota)):
#                 baslangic_durak = rota[i]
#                 bitis_durak = rota[(i + 1) % self.durak_sayisi]
# 
#                 self.feromon[baslangic_durak, bitis_durak] += feromon_birikimi
#                 self.feromon[bitis_durak, baslangic_durak] += feromon_birikimi
# 
#     def calistir(self):
#         """ACO algoritmasÄ±nÄ± Ã§alÄ±ÅŸtÄ±rÄ±r."""
# 
#         for iterasyon in range(self.iterasyon_sayisi):
#             rotalar = []
#             rota_mesafeleri = []
# 
#             for _ in range(self.karinca_sayisi):
#                 baslangic_durak = 0
#                 yeni_rota = self._rota_olustur(baslangic_durak)
#                 yeni_mesafe = self._toplam_mesafe_hesapla(yeni_rota)
# 
#                 rotalar.append(yeni_rota)
#                 rota_mesafeleri.append(yeni_mesafe)
# 
#                 if yeni_mesafe < self.en_kisa_mesafe:
#                     self.en_kisa_mesafe = yeni_mesafe
#                     self.en_iyi_rota = yeni_rota
# 
#             self._feromon_guncelle(rotalar, rota_mesafeleri)
# 
#             self.mesafe_gecmisi.append(self.en_kisa_mesafe)
# 
#         return self.en_iyi_rota, self.en_kisa_mesafe, self.mesafe_gecmisi
# 
# # ====================================================================
# # D. STREAMLIT ARABÄ°RÄ°MÄ° (ZORUNLU)
# # ====================================================================
# 
# # Sayfa ayarlarÄ±
# st.set_page_config(layout="wide")
# st.title("ğŸ“¦ KarÄ±nca Kolonisi AlgoritmasÄ± (ACO) ile Kargo Rota Optimizasyonu")
# st.subheader("BLG-307 Yapay Zeka - MuratpaÅŸa 21 MaÄŸaza Senaryosu")
# 
# # --- 1. Parametreler ve Kontrol Paneli ---
# with st.sidebar:
#     st.header("ACO Parametreleri (Girdiler)")
#     karinca_sayisi = st.slider("KarÄ±nca SayÄ±sÄ± (K)", 10, 200, 50, 10)
#     iterasyon_sayisi = st.slider("Ä°terasyon SayÄ±sÄ± (DÃ¶ngÃ¼)", 50, 500, 100, 50)
#     alfa = st.slider("Alfa (Feromon Etkisi)", 0.1, 5.0, 1.0, 0.1)
#     beta = st.slider("Beta (Heuristik Etkisi)", 1.0, 10.0, 5.0, 0.5)
#     buharlasma_orani = st.slider("BuharlaÅŸma OranÄ± (Ï)", 0.01, 0.5, 0.1, 0.01)
# 
# # --- 2. Ã‡alÄ±ÅŸtÄ±rma ve SonuÃ§lar ---
# if st.button("ğŸš€ Rota Optimizasyonunu BaÅŸlat ve Ã‡iz", type="primary"):
# 
#     mesafe_matrisi = gercek_mesafe_matrisi_olustur(koordinatlar)
# 
#     if np.max(mesafe_matrisi) >= 999999.0:
#         st.error("HATA: Mesafe Matrisi hesaplanÄ±rken bir hata oluÅŸtu. LÃ¼tfen API anahtarÄ±nÄ±zÄ±, kotanÄ±zÄ± ve adreslerinizi kontrol edin.")
#     else:
#         st.success("GerÃ§ek yol mesafeleri baÅŸarÄ±yla hesaplandÄ±.")
# 
#         # ACO'yu BaÅŸlat ve Ã‡alÄ±ÅŸtÄ±r
#         with st.spinner("ACO algoritmasÄ± en kÄ±sa rotayÄ± bulmak iÃ§in Ã§alÄ±ÅŸÄ±yor..."):
#             aco = KarincaKolonisiOptimizasyonu(
#                 mesafeler=mesafe_matrisi,
#                 karinca_sayisi=karinca_sayisi,
#                 iterasyon_sayisi=iterasyon_sayisi,
#                 alfa=alfa,
#                 beta=beta,
#                 buharlasma_orani=buharlasma_orani
#             )
#             en_iyi_rota_indeksler, en_kisa_mesafe, mesafe_gecmisi = aco.calistir()
# 
#         st.success("Optimizasyon tamamlandÄ±. En kÄ±sa rota bulundu.")
# 
#         # --- SonuÃ§larÄ±n GÃ¶rselleÅŸtirilmesi ---
#         col1, col2 = st.columns([1, 1])
# 
#         with col1:
#             st.header("âœ¨ Optimizasyon SonuÃ§larÄ±")
#             st.metric(label="En KÄ±sa Toplam Mesafe", value=f"{en_kisa_mesafe:.3f} km")
# 
#             # Rota Ä°simlerini Ã‡Ä±kar
#             tam_rota_isim = [nokta_isimleri[i] for i in en_iyi_rota_indeksler]
#             final_rota_str = " â†’ ".join([nokta_isimleri[0]] + tam_rota_isim[1:] + [nokta_isimleri[0]])
# 
#             st.text_area("Optimal Rota SÄ±rasÄ±:", final_rota_str, height=120)
# 
#             st.subheader("ğŸ“ˆ Algoritma Performans GrafiÄŸi")
#             df_gecmis = pd.DataFrame({
#                 "Ä°terasyon": list(range(1, iterasyon_sayisi + 1)),
#                 "En KÄ±sa Mesafe (km)": mesafe_gecmisi
#             })
# 
#             fig_hist = px.line(df_gecmis, x="Ä°terasyon", y="En KÄ±sa Mesafe (km)",
#                                title="Ä°terasyonlara GÃ¶re En KÄ±sa Mesafe DeÄŸiÅŸimi")
#             st.plotly_chart(fig_hist, use_container_width=True)
# 
#         with col2:
#             st.header("ğŸ—ºï¸ Rota HaritasÄ± Ãœzerinde Ã‡izim")
# 
#             merkez_koordinat = koordinatlar[0]
#             m = folium.Map(location=merkez_koordinat, zoom_start=13)
# 
#             rota_koordinatlari = [koordinatlar[i] for i in en_iyi_rota_indeksler + [en_iyi_rota_indeksler[0]]]
# 
#             # En kÄ±sa yolun harita Ã¼zerinde Ã§izimi
#             folium.PolyLine(
#                 rota_koordinatlari,
#                 color="red",
#                 weight=4,
#                 opacity=0.8,
#                 tooltip=f"En KÄ±sa Rota: {en_kisa_mesafe:.2f} km"
#             ).add_to(m)
# 
#             # Ä°ÅŸaretÃ§iler (Marker)
#             for idx, coord in enumerate(koordinatlar):
#                 renk = 'red' if idx == 0 else 'blue'
#                 ikon = 'home' if idx == 0 else 'shopping-cart'
# 
#                 folium.Marker(
#                     coord,
#                     popup=f"Durak {idx}: {nokta_isimleri[idx]}",
#                     icon=folium.Icon(color=renk, icon=ikon)
#                 ).add_to(m)
# 
#             folium_static(m)

# Streamlit'i arka planda (dahili 8501 portunda) Ã§alÄ±ÅŸtÄ±rÄ±r.
!streamlit run app.py &

!pip install streamlit googlemaps numpy pandas folium plotly streamlit-folium

!pip install pyngrok
# Bu Ngrok dosyasÄ±nÄ± indirmeyi tekrar zorluyoruz
!wget -nc https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip
!unzip -n ngrok-stable-linux-amd64.zip

# Ngrok'a kendi belirtecinizi tanÄ±tÄ±n.
# LÃ¼tfen 'SÄ°ZÄ°N_NGROK_AUTHTOKENINIZ' kÄ±smÄ±nÄ± kopyaladÄ±ÄŸÄ±nÄ±z gerÃ§ek belirteÃ§le deÄŸiÅŸtirin.
!./ngrok authtoken 36qOHUX1GihQHY8IhzFquQMJ17g_3gVg33pzJnXusgiLqWgkH

import subprocess
import time
from pyngrok import ngrok

# BURAYA KENDÄ° NGROK BELÄ°RTECÄ°NÄ°ZÄ° YAZIN! (Zorunlu)
NGROK_BELIRTECI = "36qOHUX1GihQHY8IhzFquQMJ17g_3gVg33pzJnXusgiLqWgkH"

print("Streamlit uygulamasÄ± arka planda baÅŸlÄ±yor...")

try:
    # 1. Ngrok belirtecini zorla yapÄ±landÄ±r (Bu artÄ±k Ã§alÄ±ÅŸmalÄ±)
    ngrok.set_auth_token(NGROK_BELIRTECI)

    # Arka planda Streamlit'i baÅŸlat
    subprocess.Popen(["streamlit", "run", "app.py"])

    time.sleep(5)

    # Mevcut tÃ¼m tÃ¼nelleri kapat (Temiz bir baÅŸlangÄ±Ã§ iÃ§in)
    ngrok.kill()

    # 2. Yeni tÃ¼neli en sade haliyle baÅŸlat (KonfigÃ¼rasyon hatasÄ±ndan kaÃ§Ä±nmak iÃ§in)
    genel_tÃ¼nel = ngrok.connect(8501)

    print("\n" + "="*50)
    print("âœ… UYGULAMA ERIÅIM ADRESINIZ:")
    print(genel_tÃ¼nel.public_url)
    print("="*50 + "\n")

    # TÃ¼nelin kapanmamasÄ± ve uygulamanÄ±n canlÄ± kalmasÄ± iÃ§in sÃ¼reci aÃ§Ä±k tut
    while True:
        time.sleep(1)

except Exception as e:
    print(f"HATA OLUÅTU: {e}")
    ngrok.kill()

# Gerekli klasÃ¶rÃ¼ oluÅŸtur
!mkdir -p .streamlit

# secrets.toml dosyasÄ±nÄ± oluÅŸtur ve API anahtarÄ±nÄ± iÃ§ine yaz
# âš ï¸ KENDÄ° GERÃ‡EK GOOGLE MAPS API ANAHTARINIZI BURAYA YAZIN
API_KEY_STRING = """
[google_maps]
api_key = "AIzaSyDu91HKe37zf_yD8-RDkzbG4_MD0SMdJ0Y"
"""

with open(".streamlit/secrets.toml", "w") as f:
    f.write(API_KEY_STRING)

print("âœ… .streamlit/secrets.toml dosyasÄ± baÅŸarÄ±yla oluÅŸturuldu.")